\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{graphicx}
\usepackage[small]{caption}
\usepackage{amsmath, amssymb}
\usepackage{fullpage}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
% helper macro for vectors
\usepackage{bm}
\newcommand{\vb}[1]{\ensuremath{\boldsymbol #1}}

\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}

\begin{document}
\author{Antoine Levitt}
\title{Finite volumes method for incompressible Navier-Stokes equations}
\maketitle
\abstract{
  In this project we study numerical methods to numerically approximate
the steady state of a flow. We present the Navier-Stokes equations and
their approximations for free convection (Boussinesq hypothesis). We
use the colocated scheme introduced in
\cite{che-09-col,che-08-col,che-06-num} and apply it to a benchmark
problem, a heated chimney. On this problem, different boundary
conditions are compared, and numerical properties of the scheme are
obtained.}
\tableofcontents
\newpage

\section{Introduction}
The Navier-Stokes equations, discovered in the 19th century, are a
system of non-linear partial differential equations (PDEs) describing
the motion of fluid. These equations couple velocities, pressure and
other variables as required by the application field (temperature,
electrical charge and currents \dots), in which case the Navier-Stokes
are complemented by other equations, such as conservation laws for
temperature or Maxwell laws for electromagnetism. Due to their wide
applicability, they are essential for engineering. There is also a
number of open problems in the mathematical study of these
equations. In particular, the question of existence and smoothness of
solutions is one of the Millenium Prize Problems.

Fast, accurate and reliable numerical solutions to these equations is
an important goal for engineering. Reflecting this, many commercial
and research codes have been developed. Most of them belong to the
three classes of finite volume, finite element and finite difference
methods :

\begin{itemize}
\item {\bf Finite difference method} approximates fields by their
  values on points, and interpolates derivatives. This, while the
  simplest of all methods, generally yields poor accuracy.

\item {\bf Finite element method} convert the PDE into an equivalent
  variational form, then approximate the infinite-dimensional solution
  space by a finite-dimensional one, in which the variational problem
  can be solved.

\item {\bf Finite volume method} use Green formulas to convert the
  equation into a per-cell conservation equation. Fluxes are then
  interpolated from values at neighbouring cells.
\end{itemize}

All these methods discretize the solution according to a grid. There
are various choices for the location of the unknowns inside the grid,
and methods can be split between {\bf collocated} and {\bf staggered}
grids. In collocated grids, all variables are stored in the cell
centers of the control volumes. In staggered grids, scalar variables
are still stored in cell centers, but velocities are located at cell
faces. The main motivation for using staggered grids is to avoid the
so-called checkerboard pressure modes that arise from the
discretization of first derivatives in collocated grids.

Examples of classical schemes on staggered grids include the
Marker-And-Cell (MAC) scheme
\cite{har-65-num,Pat-80-num,har-65-num,nic-92-ana,cho-97-ana,cho-97-mac}. Collocated
grids need stabilisation to avoid checkerboard modes. Various methods
exist. We use a variant of the Brezzi-Pitk{\"a}ranta approach
\cite{mat-97-apr,brezzip,brezzip2}, which consists in introducing an
artificial diffusion term in the mass conservation equation.

Various scheme also exist to decouple the equations, most notably
variants of the projection method \cite{mat-97-pre}. This method,
valid only for transient analysis (which means steady state has to be
found as a limit of the transient process, while for other methods it
can be directly computed), uses a two-step algorithm to decouple
velocities and pressure, which greatly reduces computation time. The
SIMPLE algorithm is the most popular of these variants. However, these
methods need artificial boundary conditions for pressure, and can
cause artificial boundary layers to appear.

The algorithm we use is a fully implicit, fully coupled, collocated
finite volume scheme introduced by E. ChÃ©nier and R. Eymard
\cite{che-09-col,che-08-col,che-06-num}.

To test the accuracy of these variants in the context of free
convection (where fluid flow is only a result of temperature
gradients), G. Desrayaud organised a benchmark in 2007, around a
simple problem. TODO : qu'est ce qu'on en fait, dÃ©crire les diffÃ©rents
codes.

% points \`a mentionner dans l'introduction:

% - passer en revue les m\'ethodes num\'eriques pour convection naturelle:

% sch\'emas \'el\'ements finis \cite{gun-89-fin,pironneau}, 
% volumes finis sur grilles d\'ecal\'ees, sch\'ema MAC \cite{har-65-num,Pat-80-num},
% \'etudi\'e dans \cite{har-65-num,nic-92-ana,cho-97-ana,cho-97-mac}
% volumes finis  colocalis\'es (collocated), n\'ecessitent stabilisation
% \cite{mat-97-apr,brezzip,brezzip2}

% m\'ethodes de projection (solution stationnaire n\'ecessite limite
% probl\`eme transitoire, et conditions aux limites
% artificielles en pression) \cite{mat-97-pre} 

% m\'ethodes coupl\'ees pour pb stationnaires ou transitoires
%  (mais nonlin\'earit\'es impliquent Newton ou limite pb transitoire) 



% - benchmark pour comparer diff\'erentes approches en convection naturelle

% - ranger les diff\'erents logiciels du bench selon les m\'ethodes num\'eriques
% utilis\'ees

% FLUENT \cite{mat-97-apr,mat-97-pre}

% code colocalis\'e Ch\'enier \cite{che-09-col,che-08-col,che-06-num}

% AQUILON devenu THETIS

\section{Physical context}
We study a fluid contained in a d-dimensional (d = 2 or 3) domain
$\Omega$, with a boundary $\partial \Omega$. Positions are specified
by the d-dimensional vector \vb{x}. For every time $t \in \R^+$, the
fluid is described by its velocity $\vb{v}(\vb{x}, t)$, its density
$\rho(\vb{x}, t)$, its pressure $p(\vb{x},t)$ and its temperature
$T(\vb{x}, t)$. The model used are the Navier-Stokes equations in the
Boussinesq approximation, which lead to coupled partial differential
equations (PDEs) for these variables. Together with initial and
boundary condition, they specify the evolution of the flow.
\subsection{The Navier-Stokes equations}
The Navier-Stokes equations are a reformulation of conservation of
momentum (Newton's Second Law) and conservation of mass in the case of
a fluid. The conservation of momentum equation reads
\begin{equation}
  \label{ns-mom}
  \rho \left(\frac{\partial \vb{v}}{\partial t} + \vb{v} \cdot
    \nabla \vb{v}\right) = -\nabla p + \nabla \cdot\mathbb{T} +
  \vb{f}.
\end{equation}
$\mathbb{T}$ is the stress tensor, and \vb{f} are the external volumic
forces exerting on the fluid (gravity, electromagnetic ...).  We need
an expression of $\mathbb{T}$ as a function of the other variables for
the model to be complete. The second term, $\vb{v} \cdot \nabla
\vb{v}$, known as the convective acceleration, is to be understood
as $(\vb{v} \cdot \nabla) \vb{v}$, that is, the ``transport operator''
$(\vb{v} \cdot \nabla) = \sum_{i=1}^d v_i \frac{\partial}{\partial i}$
applied to $\vb{v}$.

The conservation of mass equation is
\begin{equation}
  \label{ns-mass}
  \frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \vb{v}) = 0.
\end{equation}

These equations can be derived by applying conservation laws to an
infinitesimal volume of fluid.
\subsection{Natural convection and Boussinesq approximation}
We are now interested in studying natural convection. While in forced
convection the fluid flow is imposed (by boundary conditions either in
velocity or pressure), in natural convection the fluid is set in
motion by temperature gradients alone.  These temperature gradients
cause density inhomogeneities, which in turn affect the gravity forces
$- \rho g \vb{e_z}$ and cause relative motion of the fluid. The
Boussinesq approximation is the simplest model that still allows
natural convection : we neglect the effects of density inhomogeneities
everywhere in the Navier-Stokes equations, except in the gravity
forces. We also neglect the variation of other physical parameters
(viscosity, diffusivity, etc.).

The only external force here is gravity, so $\vb{f} = -\rho g
\vb{e_z}$. This force depends on the temperature $T$ via the density
$\rho$. Assuming small variations in $T$, we can write at the first
order $\rho - \rho_0 = - \alpha (T - T_0)$, where ($\rho_0$,$T_0$) is the
reference state, and $\alpha > 0$\footnote{At least, for ideal
  gases, where the sign can readily be checked from the equation $p =
  r T \rho$, which, assuming no variation of pressure with
  temperature, gives $\alpha = \rho_0/T_0$ around a reference state
  ($\rho_0$, $T_0$).}  is a coefficient assumed to be constant. This
leads to $\vb{f} = (-\rho_0 + \alpha (T - T_0)) g \vb{e_z}$ : this
confirms the experimental observation that hot air rises and cold air
falls.

Assuming $\rho$ to be constant in the other terms simplifies greatly
the equations. The mass equation becomes the equation of an
incompressible flow
\begin{equation}
  \label{ns-b-mass}
  \nabla \vb{v} = 0.
\end{equation}

We also assume the fluid to be Newtonian (which is the case of most
fluids commonly encountered, including the object of our study,
air). Together with incompressibility, this implies that $\nabla \cdot
\mathbb T = \mu \Delta \vb{v}$, where $\mu$ is the kinematic viscosity
of the flow, assumed to be constant.

To simplify notations, we use the variable change $p = p + \rho_0 g z$
($p$ is now the difference between the actual pressure and the
hydrostatic pressure), and $T = (T - T_0)$ ($T$ is the difference in
temperature to the reference state). The momentum equation now becomes
:
\begin{equation}
  \label{ns-mom}
  \rho \left(\frac{\partial \vb{v}}{\partial t} + \vb{v} \cdot
    \nabla \vb{v}\right) = -\nabla p + \mu \Delta \vb{v} + \alpha g
  T \vb{e_z}.
\end{equation}

The evolution of the temperature $T$ is described by energy
conservation, which, under our hypotheses, is
\begin{equation}
  C_p \rho \left(\frac{\partial T}{\partial t} + \vb{v} \cdot \nabla T\right) = k \Delta T.
\end{equation}

This is a generalisation of the heat equation in the case of a moving
medium. Note that since $\nabla \cdot \vb{v} = 0$, our variable change
$T = \delta T$ has no effect on this equation.

Finally, we adimensionalise the equations by introducing Rayleigh and
Prandtl numbers $Ra$ and $Pr$, which reduces the number of parameters
to only two. The final form of our equations is then
\begin{align}
  \label{b-mass}
  \nabla \cdot \vb{v} &= 0& \text{Mass}\\
  \label{b-mom}
  \frac{\partial \vb{v}}{\partial t} + \vb{v} \cdot
  \nabla \vb{v} +\nabla p - Pr \Delta \vb{v} - Ra Pr T
  \vb{e_z} &= \vb{0}& \text{Momentum}\\
  \label{b-ene}
  \frac{\partial T}{\partial t} + \vb{v} \cdot \nabla T - \Delta
  T&=0& \text{Energy}
\end{align}

This is a system of $d + 2$ coupled PDEs with $d+2$ variables
($\vb{v}$, $p$ and $T$). The two parameters $Ra$ and $Pr$ quantify the
relative effect of viscosity and buoyancy.

\section{Finite volumes}
We consider the steady equations ($\frac{\partial \vb{v}}{\partial t}
= \frac{\partial T}{\partial t} = 0$) in the model described above. We
prescribe boundary conditions on $\partial \Omega$. Finite volumes are
a way to approximate solutions of the PDEs, by computing their values
on elements of a mesh : we assume the domain $\Omega$ to be subdivised
in elements $K \in \mathcal{M}_\Omega$, called control volumes.

In this section, boundary conditions are taken to be homogeneous
Dirichlet conditions to simplify the presentation. Other boundary
conditions (non-homogeneous Dirichlet conditions, Neumann conditions)
may still be expressed using the same basic principles.
\subsection{Theory}
\subsubsection{Generalities}
We first integrate the equations
(\ref{b-mass}-\ref{b-mom}-\ref{b-ene}) over each control volume
$K$. Then we apply Green formulas to convert the $d$-dimensional
integrals over $K$ into $d-1$ integrals over the boundary $\partial K$
of each control volume :

TODO Eqs ici

Note that no discretisation is done at this point. The discretisation
step consists in keeping only the values of the variables at cell
centers $\vb{x}_K$, and interpolating the integrals (fluxes) with
these values. This leads to a nonlinear system of algebraic equations,
which can be solved by a Newton type method.

The difference with the classical finite differences method is that
the discretisation is performed on fluxes rather than on differential
operators. This is simpler because one differentiation order is lost :
Laplacians become gradients integrals. Another advantage is that the
finite volume method is much more easily generalized to various sorts
of meshs, and not limited to rectangular ones.

This method can also be seen as a finite element method, where the
test functions $v$ are chosen in the space of piecewise constant
functions over the mesh. This is not a subspace of the space in which
the solution is searched, since piecewise constant functions have no
gradient : it is a non-conforming finite element method. One advantage
of this method over finite element methods is that equations
(\ref{TODO}) have an obvious physical meaning : they express
conservation laws on a control volume $K$. This method is also simpler
because the approximation is piecewise constant, which makes it easier
if other physical effects are to be taken into account.

Our problem is now to choose suitable interpolation methods for the
integrals.
\subsubsection{Discretisation}
TODO
Principe de la discr\'etisation : imposer un contr\^ole pour utiliser des
arguments de compacit\'e : consistent et stable
\subsubsection{Stabilisation}
TODO Tel quel : pas inversible, modes oscillants de pression. Ajout de
la stabilisation : expliquer comment. M\'ethode de clusters. Figure de
macro.fig.

Explication : pas d'influence de $p_k$ sur l'eq pour la maille k, donc
checkeboard modes. RemÃ¨de : fausse diffusion dans conservation de la masse
\subsection{Newton method}
At the core of the algorithm is the solution of a nonlinear system of
size equal to the number of cells. We use the standard Newton
algorithm : we linearize the problem around an iterate $x_n$, solve
this linear problem to obtain $x_{n+1}$, and repeat until
convergence. Denoting by $x$ the unknowns of our problem, i.e. the
velocities, pressures and temperatures at the cell centers, by $f(x)$
the left-hand side of (\ref{TODO}), and by $J_f(x)$ the Jacobian
matrix of $f$ at point $x$, the iteration is given by
\begin{equation}
  \label{eq:newton}
  J_f(x_n) (x_{n+1} - x_n) = - f(x_n)
\end{equation}
The Jacobian is obtained by differentiating equation (\ref{TODO}). The
result is a linear system, wich is solved for $x_{n+1}$. The iteration
is carried out until convergence. We stop the iterations when both the
increment $||x_{n} - x_{n-1}||_\infty$ and the residual
$||f(x_n)||_\infty$ are lower than $\varepsilon =
10^{-10}$. Theoretically, this method is known to converge
quadratically when $x_0$ is close to the solution. In our problem,
since no approximation of the solution is available, we simply use
$x_0 = 0$, and the algorithm is numerically found to converge (see
section \ref{sec:conv_newton} for details).

\subsubsection{Solving the linear system}
Solution of linear systems is of order $\mathcal O (n^3)$. This, as
well as the memory cost of keeping $n^2$ entries, is prohibitively
large for our problems, where $n$ can be around $100\,000$. However,
because of the locality of the fluxes approximations, the value of
$f(x_n)$ on cell $i$ depends only of the value of $x_n$ on cells
connected to cell $i$ : the number of non-zero elements of the
Jacobian is of order $\mathcal O (n)$. This kind of matrices are known
as sparse matrices, and the use of appropriate data structures to
store them yields huge savings in memory and computation time.

We use a modified version of the conjugate gradient method, with a
preconditioning based on an incomplete LU factorisation. For some
ill-conditioned problems, this iterative algorithm may not converge
fast enough, or even fail to converge altogether : we then fall back
to a direct method, which is slower and less precise but has no
convergence issues.

\subsubsection{Under-relaxation}
For some problems, Newton method may oscillate around the solution. An
easy solution for this is to limit the amplitude of steps taken :
instead of $x_{n+1} = x_n + \Delta x$, we use $x_{n+1} = x_n +\theta
\Delta x$, where $\theta < 1$ is the under-relaxation factor. This
prevents oscillations but may lead to slower convergence. A sensible
choice for $\theta$ is to limit the magnitude of the steps to be no
greater than a prescribed $\delta$ : if $||\Delta x|| > \delta$,
$\theta = \delta / ||\Delta x||$, and if not, $\theta = 1$.

\subsection{Methods for instationary flow}
This work focuses on the stationary solver. However, certain boundary
conditions are easier to treat by a transient approach, which we will
now describe.

Let us begin by recalling three simple methods for solving ODEs :
forward Euler, backward Euler, and the trapezoidal rule. The problem
is to approximate a solution of $x'(t) = f(x(t))$, $x(0) =
x_0$. Using a timestep $h$, the three methods
are, with $x^i$ as an approximation of $x(i h)$ :
TODO : typesetting
$$x^{i+1} = x^i + h f(x^i)$$
$$x^{i+1} = x^i + h f(x^{i+1})$$
$$x^{i+1} = x^i + h \frac{f(x^i) + f(x^{i+1})}{2}$$

Note that while forward Euler is an explicit method, both backward
euler and the trapezoidal rule are implicit : at each iteration, an
equation has to be solved for $x^{i+1}$. Generally speaking, implicit
methods are more stable than explicit ones, which allows larger
steps to be taken.

However, our problem, once spatially discretized, is not exactly an
ODE, because of the absence of an evolution equation for
pressure. This is because, in the incompressible Navier-Stokes
equations, pressure is not explicitely given. Rather, it is
implicitely determined by the condition $\nabla \cdot \vb{v} = 0$, as
can be seen by taking the divergence of (\ref{b-mom}), which makes
$\frac{\partial \vb{v}}{\partial t}$ vanish, and gives $p$ as the
solution of a Poisson problem.

In this context, explicit methods would require the solving of a
Poisson problem at each step. Implicit methods however require no
modification except the addition of this constraint into the equations
being solved. Note that the absence of an evolution equation for
pressure is compensated by the presence of an additional constraint,
thus maintaining in the implicit system an equal number of equations
and variables.

The implementation of an implicit transient method is quite easy if
one can already solve stationary problems. Indeed, taking for instance
backward Euler method, the equation (TODO, ref eq BE) can be rewritten
as
$$f(x^{i+1}) - \frac{x^{i+1}}{h} + \frac{x^i}{h} = 0.$$

This is a minor correction of the stationnary equation $f(x) = 0$, and
can be solved in the same way. Incidentally, notice that the only
change in the Jacobian matrix is to substract $\frac{1}{h}$ on its
diagonal. For small $h$, this has the nice side effect of improving
its conditioning, since it brings the matrix closer to $\frac{1}{h}
I$, which has condition number $1$. This speeds up iterative methods
for the linear system.

The main advantage of transient methods in our context is that one
can freely mix implicit or explicit schemes for each equation. Thus,
difficult boundary conditions need not be solved implicitely, which
would require filling the Jacobian. This is useful for instance for
non-local boundary conditions which would destroy the block structure
of the Jacobian.

Our use case is for a boundary condition which reads $p = -
\frac{1}{2} V^2$, where $V$ is the average velocity on a border of our
domain. Using a fully implicit scheme (or solving the stationary
problem) would require the Jacobian to contain non-local entries,
because the pressure at cell $i$ would depend on velocities on the
whole border. This would not be compatible with the way matrices are
implemented in the code without extensive modification. By allowing
this condition to be explicit, the issue is removed : the $V$ in the
equation is the one from the last step, which does not require any
entry in the Jacobian.

Transient methods were numerically found to converge to stable
equilibria corresponding to the solutions computed by stationary
methods.
\section{The chimney problem}
TODO intro benchmark, free convection
\subsection{Physical setup}
TODO sch\'ema
\subsection{Boundary conditions}
TODO LB/GB, pression en haut ...

Pour GB : soit transitoire, soit méthode de Newton à plusieurs
étages. Pour Newton à plusieurs étages : marche à condition que
l'initial guess sur le débit soit pas trop mauvais (50 : OK, 0 :
KO). Point fixe : KO
\section{Numerical experiments}
\subsection{Methodology}
TODO param\`etres fixes \& variables
\subsection{Convergence}
\subsubsection{Newton convergence}
\label{sec:conv_newton}
Convergence can be seen in Fig. \ref{fig:conv_newton}. After a
transient, we observe the characteristic quadratic convergence of
Newton method in both residual $||f(x_n)||_\infty$ and increment $||x_{n} -
x_{n-1}||_\infty$.
\begin{figure}[htb]
\centering
\includegraphics{figs/convergence}
\caption{Convergence of Newton method in a typical case.}
\label{fig:conv_newton}
\end{figure}

\subsubsection{Mesh convergence}
TODO trouver un crit\`ere : probl\`eme mod\`ele dont la solution est connue
et trouver l'ordre ? ou alors l'admettre et v\'erifier la convergence
sur des courbes
\subsection{Influence of stabilisation}
Stabilisation, while introducing numerical errors, is an essential
part of this method. Without it, there would be trivial solutions of
the linear equations (checkerboard modes), and the linear system would
not be invertible. The stabilisation introduces a parameter $\lambda$,
which quantifies its relative effect.

$\lambda$ has to be selected neither too small nor too large. For
large $\lambda$, the pressure diffusion is so important that pressure
is nearly constant in each cluster. On the other hand, a small
$\lambda$ will introduce pressure oscillations similar to the
checkerboard modes as well as ill-conditioning in the Jacobian.

Since the right-hand side and the matrix are computed at machine
precision, the condition number would have to be very large to
introduce significant variations in the solution. However, iterative
solvers are very sensitive to conditioning and can not be used on
ill-conditioned matrices. For our problem, the iterative solver does
not converge unless $\lambda > 10^{-6}$. Further increasing $\lambda$
reduces the number of iterations needed for the iterative solver,
until it reaches a plateau around $10^{-4}$.

Even ignoring conditioning, choosing an appropriate $\lambda$ is no
easy task. Figure \ref{fig:lambdas} shows the pressure at mid-width
for our problem with different $\lambda$. For small values of
$\lambda$ (under $10^{-5}$), we can see the even-odd oscillations. As
$\lambda$ increases, clusters (here, of two cells) appear, until a
stage around $10^{-4}$ where pressure becomes constant inside the
clusters.

TODO : comparaison avec Brezzi-Pitkaranta, clusters centrés sur les
mailles, macromailles = 1
\begin{figure}[htb]
\centering
\includegraphics{figs/lambdas}
\caption{Pressure at mid-width.}
\label{fig:lambdas}
\end{figure}
\subsection{Effects of different boundary conditions}
TODO rapport avec benchmark, lequere. comparer les courbes
\begin{table}[!h]
  \centering
  \begin{tabular}{|l|c|c|c|c|}
    \hline
    & LB Bench & LB Lequere & GB Bench & GB Lequere \\
    \hline
    Cl U Neumann & 72.93 & 58.57 & 85.50 & 76.99\\
    Cl U Dirichlet & 73.23 & 59.08 & 85.51 & 77.00 \\
    \hline
  \end{tabular}
  \caption{Mass flux for different boundary conditions}
\end{table}
\subsection{Chimney in a larger box}
TODO essayer le code de E. Chénier, changer les CL (boite
ouverte). Comparer les CL de la boite restreinte avec les résultats de
la grande.
\section{Conclusion}
TODO
\listoffigures
\listoftables


\bibliographystyle{plain}
\addcontentsline{toc}{section}{References}
\bibliography{rapport}


\end{document}
